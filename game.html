<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>game</title>
<link rel="stylesheet" href="game.css" media="only all and (min-width:320px)">

<script>

var ctx; 
var canvas;
var numBomb=1;
var numMCard=29;
var backCard; 
var card; 
var isPassed = true; //not click  
//sounds
var backgroundAudio;
var gameOverAudio;
var buttonAudio;
var clickCardAudio;
var bombAudio;
var showAllCardsAudio;
var passLevelAudio;
var allClearedAudio;
var checkAudio;
var soundAble=true;
var numClickSound=0;

var backgroundImage;
var timer;
var matrix = [];  
//var firstX = 20; 
//var firstY = 100; 
var firstX = 28;
var firstY = 73; 
var margin = 4; 
var cardWidth = 50; 
var cardHeight = 50;
//score
var score=0;
var minuts=0; 
var second=0;
//pause button
var pauseButtonX=50;
var pauseButtonY=420;
var pauseButtonWidth=100;
var pauseButtonHeight=41;
//stop button
var stopButtonX=170;
var stopButtonY=420;
var stopButtonHeight=41;
var stopButtonWidth=100;
//level
var level=1;
var status=0;
var pictures = [ 
"image/icon024.png","image/icon023.png",
"image/icon022.png","image/icon021.png",
"image/icon020.png","image/icon019.png",
"image/iconbomb0.png","image/icon018.png",
"image/icon017.png","image/icon016.png",
"image/icon015.png","image/icon014.png",
"image/icon013.png","image/icon012.png",
"image/icon011.png","image/icon010.png",
"image/icon09.png","image/icon08.png",
"image/icon07.png","image/icon06.png",
"image/icon05.png","image/icon04.png",
"image/icon03.png","image/icon02.png",
"image/icon01.png","image/icon016.png",
"image/icon015.png","image/icon014.png",
"image/icon013.png","image/icon06.png",
]; 

//draw cards' back sides
function backsideCard(){ 
	ctx.drawImage(backCard, this.x,this.y, this.width, this.height);
}

//construction-for cards
function Cards(x, y, width, height,img, info,bomb){
	this.x=x;
	this.y=y;
	this.width=width;
	this.height=height;
	this.img=img;
	this.bomb=bomb;
	this.info=info;
	this.draw = backsideCard; 
}

//make matrix for cards, set up cards objects
function make_matrix(){
	var pic;
	var cardX=firstX;
	var cardY=firstY;
	
	for(var i=0;i<pictures.length;i++){
		pic = new Image();
		pic.src=pictures[i];
		bomb=0;
		if(i==6){var bomb=1;}
		card=new Cards(cardX,cardY,cardWidth,cardHeight,pic,i,bomb);
		matrix.push(card);

		cardX = cardX + cardWidth + margin;
		if(i%5==4){
			cardX=firstX;
			cardY=cardY + cardHeight + margin;
			}
		card.draw();
		}
	
	}
function shuffle() 
{ 
var i; 
var j; 
var temp_info; 
var temp_img; 
var temp_bomb;
var matrix_length = matrix.length; 
var k; 
for (k = 0; k < 3 * matrix_length; k++){  
	i = Math.floor(Math.random() * matrix_length); 
	j = Math.floor(Math.random() * matrix_length); 
	temp_info = matrix[i].info; 
	temp_img = matrix[i].img; 
	temp_bomb= matrix[i].bomb;
	matrix[i].info = matrix[j].info; 
	matrix[i].img = matrix[j].img; 
	matrix[i].bomb = matrix[j].bomb;
	matrix[j].info = temp_info; 
	matrix[j].img = temp_img; 
	matrix[j].bomb = temp_bomb; 
} 
} 
//click card method triggered by mouse event
function clickCard(ev){ 

var mx; 
var my; 
var i; 

if (ev.layerX || ev.layerX == 0) { // Firefox 
	mx = ev.layerX; 
	my = ev.layerY; 
} else if (ev.offsetX || ev.offsetX == 0) { // Opera 
	mx = ev.offsetX; 
	my = ev.offsetY; 
} 

for (i = 0; i < matrix.length; i++){  
	card = matrix[i]; 
	//find which card the player click
	if (mx > card.x && mx < (card.x + card.width) && my > card.y && my < (card.y + card.height)) 
	{ 
		ctx.drawImage(card.img, card.x, card.y, card.width, card.height);
		if (card.bomb==1){
		if(soundAble)
		bombAudio.play();
		
		}else{
		if(soundAble)
		clickCardAudio.play();
		}
		break;
	}
} 

if (i < matrix.length){ 
    //the card is bomb
	if (card.bomb==1){ 
	 isPassed=false;
	gameOver(isPassed);
	//all clicked card are not bomb
	}else if (card.bomb==0){
	numMCard--;
	if(numMCard==0){score+=500; allCleared(isPassed);}
	
	}
} 
//find the pause button
if (mx > pauseButtonX && mx < (pauseButtonX + pauseButtonWidth) && my > pauseButtonY && my < (pauseButtonY + pauseButtonHeight)) 
{ 	if (soundAble) buttonAudio.play();
    //ctx.drawImage(pauseButton, pauseButtonX, pauseButtonY);
	document.getElementById('pause').style.display = "block";
	clearInterval(timer);
}
//find the stop button
if (mx > stopButtonX && mx < (stopButtonX + stopButtonWidth) && my > stopButtonY && my < (stopButtonY + stopButtonHeight)){ 
   if (soundAble) buttonAudio.play();
	document.getElementById('stop').style.display = "block";
	clearInterval(timer);
}
} 

//onload function
function drawMap(){
	canvas = document.getElementById("myCav");
	ctx = canvas.getContext("2d");

	render();
	
	//sound able: parse from URL
	//soundAble=decodeURIComponent(location.search.substr(location.search.indexOf("sound=")+6));
	//soundAble=((soundAble=="true"||soundAble=="")? true :false);
	soundAble=((getCookie("soundCookie")=="true")? true :false);
	if(soundAble){
		document.getElementById("sound").src="image/sound.png";
	}else{
		document.getElementById("sound").src="image/nosound.png";
		numClickSound=1;
	}
	
	//background audio
	backgroundAudio = new Audio("sounds/gamingBg.wav");
	backgroundAudio.loop = true;
	backgroundAudio.volume = .15;
	backgroundAudio.load();
	if(soundAble)backgroundAudio.play();
	//gameover audio
	gameOverAudio = new Audio("sounds/gameOver.mp3");
	gameOverAudio.loop = false;
	gameOverAudio.volume = .25;
	gameOverAudio.load();
	//click cards audio
	clickCardAudio = new Audio("sounds/flipCard.wav");
	clickCardAudio.loop = false;
	clickCardAudio.volume = 1;
	clickCardAudio.load();
	//bomb audio
	bombAudio = new Audio("sounds/bomb.wav");
	bombAudio.loop = false;
	bombAudio.volume = .55;
	bombAudio.load();
	//click button audio
	buttonAudio = new Audio("sounds/buttonClick.wav");
	buttonAudio.loop = false;
	buttonAudio.volume = .55;
	buttonAudio.load();
	//automatically show all cards audio
	showAllCardsAudio = new Audio("sounds/autoShowFrontside.wav");
	showAllCardsAudio.loop = false;
	showAllCardsAudio.volume = .55;
	showAllCardsAudio.load();
	//all cleared audio
	allClearedAudio = new Audio("sounds/allCleared.mp3");
	allClearedAudio.loop = true;
	allClearedAudio.volume = .25;
	allClearedAudio.load();
	//pass level audio
	passLevelAudio = new Audio("sounds/passLevel.mp3");
	passLevelAudio.loop = false;
	passLevelAudio.volume = .55;
	passLevelAudio.load();
	
	//check all audio
	checkAudio = setInterval(function(){checkReadyState();},1000);
}
function checkReadyState() {
	if (gameOverAudio.readyState == 4 && backgroundAudio.readyState == 4 && showAllCardsAudio.readyState == 4&& clickCardAudio.readyState == 4&& bombAudio.readyState == 4 && allClearedAudio.readyState == 4 && passLevelAudio.readyState ==4 && backgroundImage.complete&&backCard.complete) {
		checkAudio=clearInterval(checkAudio);
		document.getElementById('loading').style.display = "none";
		//click listener
		setTimeout(function() {
		canvas.addEventListener('click', clickCard, false);	},3500);
		
		make_matrix();
		shuffle();
		
		//automatically show front-side after 1.5 seconds
		setTimeout(function() {
			for (i = 0; i < matrix.length; i++){
				ctx.drawImage(matrix[i].img, matrix[i].x, matrix[i].y, matrix[i].width, matrix[i].height);
				if (soundAble) showAllCardsAudio.play();
				}	 
		}, 1500);
		
		//automatically show back-side after 3.5 seconds
		setTimeout(function() {
			for (i = 0; i < matrix.length; i++){
				matrix[i].draw();
				if (soundAble) showAllCardsAudio.play();
				}   
		}, 3500);
		
		update();
		
		}

}

/*function main(){
	update();
	//render();	
	requestAnimationFrame(main);
}*/

//timer
function update(){
	setTimeout(function() {
			timer=setInterval(function(){
				second++;
				if(second==60){
					minuts++;
					second=0;
				}
				//ctx.clearRect(190,30,120,30);
				//ctx.fillText("Time:"+minuts+":"+second,200, 30);
				document.getElementById('timer').innerHTML = minuts+":"+second;
			},1000);
    }, 3500);
}

// Cross-browser support for requestAnimationFrame

//requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || window.mozRequestAnimationFrame;

//automatically update the score and timer
//requestAnimationFrame(main);


function render(){
	//background image;
    backgroundImage=new Image();
	backgroundImage.src="image/background0.png";
	ctx.drawImage(backgroundImage, 0, 0);
	
	//level background shadow
	backgroundLevel=new Image();
	backgroundLevel.src="image/gameLevel.png";
	ctx.drawImage(backgroundLevel, 0, 0);
	
	//game background shadow
	backgroundShadow=new Image();
	backgroundShadow.src="image/gameBackground.png";
	ctx.drawImage(backgroundShadow, 0, 55);
	
	//backSide of cards
	backCard=new Image();
    backCard.src="image/back01.png";
	
	//game title
	document.getElementById('level').innerHTML=level;
	
	//pause button
	pauseButton=new Image();
	pauseButton.src="image/pauseButton.png";
	ctx.drawImage(pauseButton, pauseButtonX, pauseButtonY);
	//pauseClick=new Image();
	//pauseClick.src="image/pauseClicked.png";
	
	//stop button
	stopButton=new Image();
	stopButton.src="image/stopButton.png";
	ctx.drawImage(stopButton, stopButtonX, stopButtonY);
}

function gameOver(isPassed) {
	if(!isPassed){
		//window.location.href="gameOver.html?scores="+score;
		//backgroundAudio.pause();
		//gameOverAudio.currentTime = 0;
		//gameOverAudio.play();
		setTimeout(function() {
			backgroundAudio.pause();
			gameOverAudio.currentTime = 0;
			if (soundAble) gameOverAudio.play();
			document.getElementById('gameOver').style.display = "block";
			document.getElementById("scoreGameOver").innerHTML=score;
		},500);
		clearInterval(timer);
	}

}
function allCleared(isPassed) {
	if(isPassed){
		setTimeout(function() {
			backgroundAudio.pause();
			allClearedAudio.currentTime = 0;
			if (soundAble) allClearedAudio.play();
			document.getElementById('allCleared').style.display = "block";
			document.getElementById("scoreAllCleared").innerHTML=score;
			document.getElementById("score").innerHTML=score;
		},500);
		clearInterval(timer);
	}
}
function getCookie(c_name){
	if (document.cookie.length>0)
	{
	c_start=document.cookie.indexOf(c_name + "=");
	if (c_start!=-1)
	{
	c_start=c_start + c_name.length+1;
	c_end=document.cookie.indexOf(";",c_start);
	if (c_end==-1) c_end=document.cookie.length;
	return unescape(document.cookie.substring(c_start,c_end));
	}
	}
	return "";
}
function setCookie(c_name,value,expiredays){
	var exdate=new Date();
	exdate.setDate(exdate.getDate()+expiredays);
	document.cookie=c_name+ "=" +escape(value)+
	((expiredays==null) ? "" : ";expires="+exdate.toGMTString());
}
</script>
</head>

<body onload="drawMap()">
<!--canvas-->
<canvas id="myCav" width="320" height="480"
style="border:1px solid #c3c3c3;">
Your browser does not support the canvas element.
</canvas>
<!--no display images-->
<div id="images">
<img src="image/back01.png" alt="backside of card" width="50" height="50" id="bomb" >
<img src="image/background0.png" alt="background image" width="320" height="480">
<img src="image/gameLevel.png" alt="game level background shadow" width="30" height="30">
<img src="image/gameBackground.png" alt="game area background shadow" width="320" height="480" >
<img src="image/pauseButton.png" alt="pause button image" width="25" height="30" ><!---->
<img src="image/stopButton.png" alt="stop button image" width="25" height="30" >
</div>
<!--titles-->
<div class="level">Level <span id="level">0</span>/10</div>
<div class="timer">Time: <span id="timer">0:0</span></div>
<div class="score">Scores: <span id="score">0</span></div>
<!--game over page-->
<div id="gameOver">
<p>GAME OVER<br> <span >Your Score: <span id="scoreGameOver"></span></span></p>
<img class="leftButton" src="image/restartButton.png" alt="restart button" width="100" height="41" onclick="if (soundAble) buttonAudio.play();setTimeout(function(){window.location.href='game.html';},500);">
<img class="rightButton" src="image/stopButton.png" alt="stop button" width="100" height="41" onclick="
if (soundAble) buttonAudio.play();
setTimeout(function(){window.location.href='homepage.html';},500);

">
</div>

<!--all cleared page-->
<div id="allCleared">
<p>ALL CLEARED!!!<br> <span>Your Score: <span id="scoreAllCleared"></span></span></p>
<img class="leftButton" src="image/restartButton.png" alt="restart button" width="100" height="41" onclick="if (soundAble) buttonAudio.play();setTimeout(function(){window.location.href='game.html';},500);">
<img class="rightButton" src="image/stopButton.png" alt="stop button" width="100" height="41" onclick="
if (soundAble) buttonAudio.play();
setTimeout(function(){window.location.href='homepage.html';},500);
 ">
</div>
<!--pause page-->
<div id="pause">
<img id="sound" src="image/sound.png" alt="sound button" width="45" height="47" onclick="
numClickSound++;
if(numClickSound%2==1){
backgroundAudio.pause();

soundAble=false;
setCookie('soundCookie',soundAble,365);
document.getElementById('sound').src='image/nosound.png';
}else{
soundAble=true;
setCookie('soundCookie',soundAble,365);
backgroundAudio.play();
document.getElementById('sound').src='image/sound.png';
}">
<p>Click play to continue.<br>Click stop to quit the game.</p>

<img class="leftButton" src="image/continueButton.png" alt="continue button" width="100" height="41" onclick="
if (soundAble) buttonAudio.play();
document.getElementById('pause').style.display='none';
timer=setInterval(function(){
				second++;
				if(second==60){
				minuts++;
				second=0;
				}
				document.getElementById('timer').innerHTML = minuts+':'+second;
			},1000)">
<img class="rightButton" src="image/stopButton.png" alt="stop button" width="100" height="41" onclick="if (soundAble) buttonAudio.play();document.getElementById('pause').style.display='none'; document.getElementById('stop').style.display = 'block';">
</div>
<!--stop page-->
<div id="stop">
<p>Are you sure to quit<br> this game?</p>
<img class="leftButton" src="image/yesButton.png" alt="yes button" width="100" height="41"  onclick="if (soundAble) buttonAudio.play();setTimeout(function(){window.location.href='homepage.html';},500);">
<img class="rightButton" src="image/noButton.png" alt="no button" width="100" height="41" onclick="if (soundAble) buttonAudio.play(); document.getElementById('stop').style.display='none';
timer=setInterval(function(){
				second++;
				if(second==60){
				minuts++;
				second=0;
				}
				document.getElementById('timer').innerHTML = minuts+':'+second;
			},1000)">
</div>

<!--loading page-->
<div class="loading" id="loading">LOADING...<p>Please wait</p></div>

</body>

</html>